<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Sunghyun Park">
    <meta name="description" content="Blog posts by Sunghyun Park">
    <title>Sunghyun Park – Blog</title>
    <link rel="shortcut icon" type="image/x-icon" href="static/img/jlcrimson.png">
    <link href="static/plugin/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/plugin/academicons/css/academicons.min.css" rel="stylesheet">
    <link href="static/plugin/et-line/style.css" rel="stylesheet">
    <link href="static/plugin/themify-icons/themify-icons.css" rel="stylesheet">
    <link href="static/plugin/owl-carousel/css/owl.carousel.min.css" rel="stylesheet">
    <link href="static/plugin/magnific/magnific-popup.css" rel="stylesheet">
    <link href="static/plugin/scroll/jquery.mCustomScrollbar.min.css" rel="stylesheet">
    <link href="static/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://kit.fontawesome.com/912387ca83.js" crossorigin="anonymous"></script>

    <script>
        // Configure inline math delimiters and ignore tags that should not be processed.
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] }
        };
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body data-spy="scroll" data-target="#navbar-collapse-toggle" data-offset="70" class="theme-light">
    <div id="loading">
        <div class="load-circle"><span class="one"></span></div>
    </div>
    <div class="mob-header">
        <div class="d-flex">
            <div class="navbar-brand">
                <a class="logo-text" href="index.html">
                    Sunghyun Park
                </a>
            </div>
            <button class="toggler-menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>
    <header class="header-left" id="navbar-collapse-toggle">
        <div class="scroll-bar">
            <div class="hl-top">
                <div class="hl-logo">
                    <a href="index.html">SP</a>
                </div>
            </div>
            <ul class="nav nav-menu">
                <li>
                    <a class="nav-link" href="index.html#about" data-toggle="tooltip" title="Home">
                        <i class="fas fa-home"></i>
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="index.html#education" data-toggle="tooltip" title="Education">
                        <i class="fas fa-graduation-cap"></i>
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="index.html#publications" data-toggle="tooltip" title="Projects">
                        <i class="fas fa-file-alt"></i>
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="index.html#topics" data-toggle="tooltip" title="Topics of Interest">
                        <i class="fas fa-lightbulb"></i>
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="index.html#skills" data-toggle="tooltip" title="Skills">
                        <i class="fas fa-cogs"></i>
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="index.html#experience" data-toggle="tooltip" title="Experience">
                        <i class="fas fa-briefcase"></i>
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="index.html#awards" data-toggle="tooltip" title="Awards & Honors">
                        <i class="fas fa-trophy"></i>
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="gallery.html" data-toggle="tooltip" title="Gallery">
                        <i class="fas fa-images"></i>
                    </a>
                </li>
                <li>
                    <a class="nav-link active" href="blog.html" data-toggle="tooltip" title="Blog">
                        <i class="fas fa-blog"></i>
                    </a>
                </li>
            </ul>
        </div>
    </header>
    <main class="main-left">
        <section id="blog" class="section">
            <div class="container">
                <div class="title">
                    <h3>Posts.</h3>
                    <p>All posts in this blog are stored as Markdown (<code>.md</code>) files in the <code>blogs</code> folder of GitHub repository.  Use the category tree and search box to find posts and click a card to read the full article.</p>
                </div>
                <div class="row">
                    <aside class="col-12 col-md-4 col-lg-3 mb-4" id="blog-sidebar">
                        <h5 class="mb-3">Browse by category</h5>
                        <nav id="category-tree" class="cat-tree"></nav>
                    </aside>
                    <div class="col-12 col-md-8 col-lg-9" id="blog-main">
                        <div class="form-group">
                            <input type="search" id="blog-search" class="form-control" placeholder="Search posts...">
                        </div>
                        <div id="blog-feed"></div>
                        
                        <div id="blog-post" style="display: none;">
                            <div class="post-header">
                                <div class="post-meta">
                                    <img id="post-author-avatar" src="static/img/jlcrimson.png" class="author-avatar" alt="Author">
                                    <span id="post-author-name"></span>
                                    <span class="meta-separator">·</span>
                                    <time id="post-date"></time>
                                </div>
    
                                <h1 id="post-title" class="post-title"></h1>
    
                                <div id="post-tags" class="post-tags"></div>

                                <p id="post-summary" class="post-summary"></p>
                                
                                <div class="post-controls mb-4">
                                    <button id="back-to-list" class="btn btn-sm btn-outline-secondary">← Back to List</button>
                                </div>
                            </div>
                            <hr class="post-divider">
                            <div id="blog-post-content" class="post-content"></div>
                        </div>
                        </div>
                </div>
            </div>
        </section>
    </main>
    <script src="static/js/jquery-3.2.1.min.js"></script>
    <script src="static/js/jquery-migrate-3.0.0.min.js"></script>
    <script src="static/plugin/bootstrap/js/bootstrap.min.js"></script>
    <script src="static/plugin/scroll/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="static/plugin/owl-carousel/js/owl.carousel.min.js"></script>
    <script src="static/plugin/particles/particles.min.js"></script>
    <script src="static/plugin/magnific/jquery.magnific-popup.min.js"></script>
    <script src="static/js/custom.js"></script>
    
    <script>
        /**
         * Customize the Markdown renderer to support relative images from the repository.
         */
        (function() {
            const renderer = new marked.Renderer();
            renderer.image = function (href, title, text) {
                console.log('Image renderer called with:', { href, title, text });
                console.log('href type:', typeof href, 'href value:', href);
                
                let src = href;
                if (href && typeof href === 'string' && !href.match(/^https?:\/\//) && !href.startsWith('data:')) {
                    const cleanHref = href.replace(/^\/+/, '');
                    src = `https://raw.githubusercontent.com/${githubUsername}/${githubRepo}/${branch}/${cleanHref}`;
                    console.log('Converted image path:', src);
                } else if (href && typeof href === 'object') {
                    // Handle case where href is an object
                    console.log('href is an object, trying to extract string value');
                    src = href.toString();
                }
                const titleAttr = title ? ` title="${title}"` : '';
                const result = `<img src="${src}" alt="${text}"${titleAttr} class="img-fluid my-3">`;
                console.log('Final image HTML:', result);
                return result;
            };
            marked.setOptions({ renderer });
        })();
        
        const githubUsername = 'SunghyunP-ark';
        const githubRepo = 'sunghyunp-ark.github.io';
        const branch = 'main';
        const blogDir = 'blogs';

        function parseFrontMatter(md) {
            md = md.replace(/\r\n/g, '\n');
            const fmMatch = md.match(/^---\s*\n([\s\S]*?)\n---\s*\n/);
            let front = {};
            let content = md;
            if (fmMatch) {
                const frontRaw = fmMatch[1];
                frontRaw.split(/\n/).forEach(line => {
                    const idx = line.indexOf(':');
                    if (idx !== -1) {
                        const key = line.slice(0, idx).trim();
                        let val = line.slice(idx + 1).trim();
                        if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
                            val = val.slice(1, -1);
                        }
                        front[key] = val;
                    }
                });
                content = md.slice(fmMatch[0].length);
            }
            return { front, content };
        }

        const posts = [];
        const categoryTree = { name: 'All', path: [], children: {}, posts: [] };
        let currentCategoryPath = [];
        let searchQuery = '';

        async function fetchPostsFromDir(dir = '', parentPath = []) {
            const basePath = blogDir + (dir ? '/' + dir : '');
            const url = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${basePath}?ref=${branch}`;
            console.log('Fetching from:', url);
            let files;
            try {
                const resp = await fetch(url);
                console.log('Response status:', resp.status);
                files = await resp.json();
                console.log('Files found:', files.length);
            } catch (err) {
                console.error('Error listing directory', basePath, err);
                return;
            }
            files.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type === 'dir' ? -1 : 1;
            });
            for (const item of files) {
                if (item.type === 'dir') {
                    const newPath = [...parentPath, item.name];
                    await fetchPostsFromDir(dir ? `${dir}/${item.name}` : item.name, newPath);
                } else if (item.type === 'file' && item.name.endsWith('.md')) {
                    console.log('Processing markdown file:', item.name);
                    try {
                        const res = await fetch(item.download_url);
                        const mdContent = await res.text();
                        const { front, content } = parseFrontMatter(mdContent);
                        console.log('Parsed front matter:', front);
                        const title = front.title || item.name.replace(/\.md$/, '');
                        const date = front.date || '';
                        const author = front.author || 'Sunghyun Park'; // Read author, with a default value
                        const image = front.image || 'placeholder_light_gray_block.png';
                        const html = marked.parse(content);
                        console.log('Parsed HTML content:', html);
                        console.log('Original markdown content:', content);
                        console.log('Looking for image in HTML:', html.includes('<img'));
                        console.log('Looking for DDPMtn in HTML:', html.includes('DDPMtn'));
                        let excerpt = front.summary || ''; // Use summary from frontmatter if available
                        if (!excerpt) {
                            const tmp = document.createElement('div');
                            tmp.innerHTML = html;
                            const text = tmp.textContent || tmp.innerText || '';
                            const words = text.trim().split(/\s+/).slice(0, 40);
                            excerpt = words.join(' ');
                        }

                        let categoryPaths = [];
                        if (front.categories !== undefined) {
                            let cats = front.categories.trim();
                            let arr = cats.startsWith('[') && cats.endsWith(']') ? JSON.parse(cats) : [cats];
                            arr.forEach(cat => {
                                const segs = cat.split('/').map(s => s.trim()).filter(Boolean);
                                if (segs.length > 0) categoryPaths.push(segs);
                            });
                        } else if (front.category !== undefined) {
                            const cat = front.category.trim();
                            const segs = cat.split('/').map(s => s.trim()).filter(Boolean);
                            if (segs.length > 0) categoryPaths.push(segs);
                        }
                        if (categoryPaths.length === 0) {
                            categoryPaths.push(parentPath);
                        }
                        const postIndex = posts.length;
                        posts.push({ title, date, author, image, html, excerpt, categoryPaths });
                        console.log('Added post:', title, 'Total posts:', posts.length);
                        console.log('Category paths for this post:', categoryPaths);
                        categoryPaths.forEach(cp => {
                            console.log('Adding post to category path:', cp);
                            addPostToTree(cp, postIndex);
                        });
                    } catch (err) {
                        console.error('Error loading post', item.name, err);
                    }
                }
            }
        }

        function addPostToTree(pathSegments, postIndex) {
            let node = categoryTree;
            for (const seg of pathSegments) {
                if (!node.children[seg]) {
                    node.children[seg] = { name: seg, path: [...(node.path || []), seg], children: {}, posts: [] };
                }
                node = node.children[seg];
            }
            node.posts.push(postIndex);
        }

        function countPostsInNode(node) {
            let count = node.posts ? node.posts.length : 0;
            for (const key in node.children) {
                count += countPostsInNode(node.children[key]);
            }
            return count;
        }

        function renderCategoryTree() {
            const container = document.getElementById('category-tree');
            container.innerHTML = '';
            const rootLi = document.createElement('div');
            rootLi.className = 'cat-item root';
            const rootLabel = document.createElement('div');
            rootLabel.className = 'cat-label d-flex justify-content-between align-items-center';
            rootLabel.innerHTML = `<span>All posts</span><span class="badge badge-light ml-2">${posts.length}</span>`;
            rootLabel.addEventListener('click', () => {
                currentCategoryPath = [];
                renderBlogFeed();
                updateActiveCategory();
            });
            rootLi.appendChild(rootLabel);
            container.appendChild(rootLi);
            
            console.log('Rendering category tree, total categories:', Object.keys(categoryTree.children).length);
            console.log('Category tree structure:', categoryTree);

            function build(node, parentEl) {
                const ul = document.createElement('ul');
                ul.className = 'cat-sublist';
                for (const name of Object.keys(node.children).sort()) {
                    const child = node.children[name];
                    const li = document.createElement('li');
                    li.className = 'cat-item';
                    li.dataset.path = JSON.stringify(child.path);
                    const label = document.createElement('div');
                    label.className = 'cat-label d-flex justify-content-between align-items-center';
                    label.innerHTML = `<span>${name}</span><span class="badge badge-light ml-2">${countPostsInNode(child)}</span>`;
                    label.addEventListener('click', (e) => {
                        e.stopPropagation();
                        li.classList.toggle('open');
                        currentCategoryPath = child.path;
                        renderBlogFeed();
                        updateActiveCategory();
                    });
                    li.appendChild(label);
                    if (Object.keys(child.children).length > 0) {
                        build(child, li);
                    }
                    ul.appendChild(li);
                }
                parentEl.appendChild(ul);
            }
            build(categoryTree, container);
            updateActiveCategory();
        }

        function updateActiveCategory() {
            const items = document.querySelectorAll('#category-tree .cat-item');
            items.forEach(item => {
                item.classList.remove('active');
                const path = JSON.parse(item.dataset.path || '[]');
                if (path.length === currentCategoryPath.length && path.every((seg, idx) => seg === currentCategoryPath[idx])) {
                    item.classList.add('active');
                    let parent = item.parentElement;
                    while (parent && parent.id !== 'category-tree') {
                        if (parent.classList.contains('cat-item')) {
                            parent.classList.add('open');
                        }
                        parent = parent.parentElement;
                    }
                }
            });
        }

        function renderBlogFeed() {
            const feed = document.getElementById('blog-feed');
            const postView = document.getElementById('blog-post');
            
            if (postView.style.display !== 'none') { return; }
            
            feed.className = 'blog-grid';
            feed.innerHTML = '';

            const indices = [];
            posts.forEach((post, idx) => {
                let matchCategory = currentCategoryPath.length === 0 || 
                    (Array.isArray(post.categoryPaths) && post.categoryPaths.some(cp => 
                        Array.isArray(cp) && currentCategoryPath.every((seg, i) => cp[i] === seg)
                    ));

                const lcQuery = searchQuery.toLowerCase();
                const matchSearch = !searchQuery || (
                    (post.title && post.title.toLowerCase().includes(lcQuery)) ||
                    (post.date && post.date.toLowerCase().includes(lcQuery)) ||
                    (post.excerpt && post.excerpt.toLowerCase().includes(lcQuery))
                );

                if (matchCategory && matchSearch) {
                    indices.push(idx);
                }
            });

            indices.sort((a, b) => (posts[b].date || '').localeCompare(posts[a].date || ''));

            if (indices.length === 0) {
                feed.innerHTML = '<p class="text-muted">No posts found.</p>';
                return;
            }

            indices.forEach(idx => {
                const post = posts[idx];
                const card = document.createElement('article');
                card.className = 'card';
                card.onclick = () => showPost(idx);

                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'card-tags';
                if (post.categoryPaths && post.categoryPaths.length > 0 && post.categoryPaths[0].length > 0) {
                    post.categoryPaths[0].forEach(catName => {
                        const tag = document.createElement('span');
                        tag.className = 'tag';
                        tag.textContent = catName.toUpperCase();
                        tagsContainer.appendChild(tag);
                    });
                }
                card.appendChild(tagsContainer);

                const imageLink = document.createElement('div');
                imageLink.className = 'card-image-link';
                const image = document.createElement('img');
                image.src = post.image;
                image.alt = post.title;
                image.className = 'card-image';
                image.onerror = function() {
                    this.style.backgroundColor = '#e2e8f0';
                    this.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                };
                imageLink.appendChild(image);
                card.appendChild(imageLink);

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                if (post.date) {
                    const dateEl = document.createElement('time');
                    dateEl.className = 'card-date';
                    dateEl.textContent = post.date;
                    cardBody.appendChild(dateEl);
                }

                const titleEl = document.createElement('h3');
                titleEl.className = 'card-title';
                titleEl.textContent = post.title;
                cardBody.appendChild(titleEl);

                const summaryEl = document.createElement('p');
                summaryEl.className = 'card-summary';
                summaryEl.textContent = post.excerpt ? `${post.excerpt.replace(/\.+$/, '')}...` : '';
                cardBody.appendChild(summaryEl);
                
                card.appendChild(cardBody);
                feed.appendChild(card);
            });
        }
        
        // ========= START: REWRITTEN showPost FUNCTION =========
        function showPost(index) {
            const post = posts[index];
            if (!post) return;

            // Hide feed and search bar
            document.getElementById('blog-feed').style.display = 'none';
            document.getElementById('blog-search').style.display = 'none';
            
            // Populate header elements
            document.getElementById('post-author-name').textContent = post.author;
            document.getElementById('post-date').textContent = post.date;
            document.getElementById('post-title').textContent = post.title;
            document.getElementById('post-summary').textContent = post.excerpt ? `${post.excerpt.replace(/\.+$/, '')}...` : '';

            // Populate tags
            const tagsContainer = document.getElementById('post-tags');
            tagsContainer.innerHTML = '';
            if (post.categoryPaths && post.categoryPaths.length > 0) {
                // Use the first category path for tags
                post.categoryPaths[0].forEach(catName => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag';
                    tagEl.textContent = catName.toUpperCase();
                    tagsContainer.appendChild(tagEl);
                });
            }
            
            // Set main content and render MathJax
            const postContent = document.getElementById('blog-post-content');
            postContent.innerHTML = post.html;
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                MathJax.typesetPromise([postContent]).catch(err => console.warn('MathJax typesetting error:', err));
            }
            
            // Show the post view
            document.getElementById('blog-post').style.display = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        // ========= END: REWRITTEN showPost FUNCTION =========

        document.addEventListener('DOMContentLoaded', () => {
            const backButton = document.getElementById('back-to-list');
            backButton.addEventListener('click', () => {
                document.getElementById('blog-post').style.display = 'none';
                document.getElementById('blog-search').style.display = '';
                document.getElementById('blog-feed').style.display = '';
                renderBlogFeed();
                const blogSection = document.getElementById('blog');
                if (blogSection) {
                    window.scrollTo({ top: blogSection.offsetTop, behavior: 'smooth' });
                }
            });
            
            fetchPostsFromDir('', []).then(() => {
                console.log('All posts loaded, total:', posts.length);
                console.log('Posts:', posts.map(p => p.title));
                renderCategoryTree();
                renderBlogFeed();
            });
            
            document.getElementById('blog-search').addEventListener('input', (e) => {
                searchQuery = e.target.value.trim();
                renderBlogFeed();
            });
        });
    </script>
</body>

</html>